services:
  devcontainer:
    build:
      context: .
      dockerfile: Dockerfile
    # Privileged mode required for QEMU with KVM acceleration
    privileged: true
    # Capabilities for QEMU/KVM and hardware testing
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN        # For mount operations
      - NET_ADMIN        # For network configuration
      - IPC_LOCK         # For TPM memory locking
    # Device access for KVM acceleration
    devices:
      - /dev/kvm:/dev/kvm
    # Shared memory for QEMU
    shm_size: '2gb'
    # Memory limits for TPM operations
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ..:/workspace:cached
      - go-mod-cache:/go/pkg/mod
      - go-build-cache:/home/vscode/.cache/go-build
      - /var/run/docker.sock:/var/run/docker.sock
      # CanoKey QEMU state directory (for VM-based FIDO2 testing)
      - canokey-state:/var/lib/canokey
    environment:
      - GOPATH=/go
      - CGO_ENABLED=1
      - TPM_USE_SIMULATOR=true
      - TPM_SIMULATOR_HOST=swtpm
      - TPM_SIMULATOR_PORT=2321
      - SOFTHSM2_CONF=/etc/softhsm/softhsm2.conf
      - PKCS11_LIBRARY=/usr/lib/softhsm/libsofthsm2.so
      # Integration test endpoints
      - KEYSTORE_UNIX_SOCKET=/var/run/keychain/keychain.sock
      - KEYSTORE_REST_URL=http://keychain-server:8443
      - KEYSTORE_GRPC_ADDR=keychain-server:9443
      - KEYSTORE_QUIC_URL=https://keychain-server:8444
      - KEYSTORE_MCP_ADDR=keychain-server:9444
      # CanoKey QEMU configuration (for VM-based FIDO2 testing)
      - QEMU_CANOKEY_BIN=/usr/local/bin/qemu-system-x86_64-canokey
      - CANOKEY_STATE_DIR=/var/lib/canokey
      # CanoKey hardware configuration (uses OpenSC PKCS#11)
      - CANOKEY_PKCS11_LIBRARY=/usr/lib/x86_64-linux-gnu/opensc-pkcs11.so
      - CANOKEY_PIN=123456
      - CANOKEY_SOPIN=12345678
      # FIDO2 configuration (auto-detect device or use FIDO2_DEVICE_PATH)
      - FIDO2_PIN=123456
      - FIDO2_DEVICE_PATH=
    networks:
      - keychain-dev
    depends_on:
      swtpm:
        condition: service_healthy
      softhsm:
        condition: service_healthy
    security_opt:
      - seccomp:unconfined
    command: sleep infinity

  # SWTPM TPM 2.0 Simulator (shared across all tests)
  swtpm:
    build:
      context: ../test/docker/swtpm
      dockerfile: Dockerfile
    image: go-keychain-swtpm:dev
    container_name: keychain-dev-swtpm
    volumes:
      - swtpm-state:/var/lib/swtpm/tpmstate
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2321"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - keychain-dev

  # SoftHSM PKCS#11 Service (shared across all tests)
  softhsm:
    build:
      context: ../test/docker/softhsm
      dockerfile: Dockerfile
    image: go-keychain-softhsm:dev
    container_name: keychain-dev-softhsm
    volumes:
      - softhsm-tokens:/tokens
    environment:
      - SOFTHSM2_CONF=/home/softhsm/softhsm2.conf
      - PKCS11_LIBRARY=/usr/local/lib/softhsm/libsofthsm2.so
    healthcheck:
      test: ["CMD", "test", "-f", "/usr/local/lib/softhsm/libsofthsm2.so"]
      interval: 10s
      timeout: 3s
      retries: 3
    networks:
      - keychain-dev

  # Keychain server for integration tests (optional, started manually)
  keychain-server:
    build:
      context: ..
      dockerfile: Dockerfile
    image: go-keychain-server:dev
    container_name: keychain-dev-server
    ports:
      - "8443:8443"   # REST API
      - "9443:9443"   # gRPC
      - "8444:8444"   # QUIC
      - "9444:9444"   # MCP
      - "9090:9090"   # Metrics
    volumes:
      - keychain-data:/data
      - keychain-socket:/var/run/keychain
    environment:
      - KEYCHAIN_CONFIG=/etc/keychain/keychaind.yaml
      - KEYSTORE_LOG_LEVEL=debug
      - KEYSTORE_DATA_DIR=/data
      - TPM_DEVICE_PATH=tcp://swtpm:2321
      - TPM_USE_SIMULATOR=true
      - PKCS11_LIBRARY=/usr/local/lib/softhsm/libsofthsm2.so
      - SOFTHSM2_CONF=/etc/softhsm/softhsm2.conf
    depends_on:
      swtpm:
        condition: service_healthy
      softhsm:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8443/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - keychain-dev
    command: ["/app/keychaind"]

  # Virtual FIDO2 Authenticator Service (for WebAuthn testing without hardware)
  # Uses software CTAP2 implementation with socket-based interface
  softfido:
    build:
      context: .
      dockerfile: Dockerfile.softfido
    image: go-keychain-softfido:dev
    container_name: keychain-dev-softfido
    volumes:
      - softfido-state:/var/lib/softfido
      - softfido-run:/var/run/softfido
    environment:
      - SOFTFIDO_PIN=123456
    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck.sh"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - keychain-dev

volumes:
  go-mod-cache:
  go-build-cache:
  swtpm-state:
  softhsm-tokens:
  canokey-state:
  keychain-data:
  keychain-socket:
  softfido-state:
  softfido-run:

networks:
  keychain-dev:
    driver: bridge
